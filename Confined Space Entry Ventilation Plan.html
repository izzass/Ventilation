<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Confined Space Entry Ventilation Plan</title>
  <style>
    :root {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      --border-color: #cbd5e1;
      --green-bg: #dcfce7;
      --red-bg: #fee2e2;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      padding: 1.5rem;
      background: #f7fafc;
      color: #111827;
    }
    h1 {
      text-align: center;
      font-size: 1.4rem;
      margin: 0 0 0.25rem;
    }
    h2 {
      font-size: 1.05rem;
      margin: 0.9rem 0 0.35rem;
      color: #374151;
    }
    h3 {
      font-size: 0.95rem;
      margin: 0.75rem 0 0.25rem;
      color: #4b5563;
    }
    .section {
      background: #ffffff;
      border-radius: 0.5rem;
      padding: 1rem;
      margin-bottom: 1rem;
      box-shadow: 0 1px 4px rgba(15,23,42,0.08);
    }
    table {
      border-collapse: collapse;
      width: 100%;
    }
    th, td {
      border: 1px solid var(--border-color);
      padding: 0.25rem 0.4rem;
      font-size: 0.78rem;
      vertical-align: middle;
      white-space: nowrap;
      text-align: center;
    }
    th {
      background: #f1f5f9;
      font-weight: 600;
    }
    td input[type="text"] {
      text-align: left;
    }
    input[type="number"], input[type="text"], textarea {
      width: 100%;
      border: 1px solid #d1d5db;
      border-radius: 3px;
      padding: 0.12rem 0.2rem;
      font-size: 0.78rem;
      background: #ffffff;
    }
    input[type="number"] {
      text-align: center;
    }
    input[readonly] {
      background: #f9fafb;
      color: #111827;
    }
    textarea {
      min-height: 3rem;
      resize: vertical;
    }
    .template-label {
      font-size: 0.8rem;
      font-weight: 600;
      margin-top: 0.5rem;
      margin-bottom: 0.15rem;
    }
    .inline-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit,minmax(220px,1fr));
      gap: 0.5rem;
    }
    .field-pair {
      display: grid;
      grid-template-columns: 170px 1fr;
      align-items: center;
      gap: 0.25rem;
      font-size: 0.78rem;
    }
    .field-pair label {
      white-space: normal;
    }
    .shape-switch {
      display: flex;
      gap: 1.5rem;
      font-size: 0.8rem;
      margin-bottom: 0.5rem;
    }
    .shape-switch label {
      display: inline-flex;
      align-items: center;
      gap: 0.25rem;
      cursor: pointer;
    }
    .shape-section {
      display: none;
      margin-top: 0.25rem;
    }
    .shape-section.active {
      display: block;
    }
    .small {
      font-size: 0.78rem;
      font-style: italic;
      text-align: left;
    }
    .top-note {
      text-align: center;
    }
    .status-box {
      padding: 0.15rem 0.3rem;
      border-radius: 0.25rem;
      font-size: 0.78rem;
      font-weight: 600;
      display: inline-block;
      min-width: 150px;
    }
    .status-ok {
      background: var(--green-bg);
      border: 1px solid #22c55e;
      color: #14532d;
    }
    .status-bad {
      background: var(--red-bg);
      border: 1px solid #ef4444;
      color: #7f1d1d;
    }
    .signature-block { margin-bottom: 2.5rem; }
    .signature-space {
      height: 60px;
      width: 100%;
      display: block;
    }
    .sketch-box {
      border: 1px solid var(--border-color);
      border-radius: 0.35rem;
      height: 120px;
      background: #f9fafb;
    }
    .actions {
      display: flex;
      justify-content: flex-end;
      gap: 0.5rem;
      margin-top: 0.75rem;
    }
    button {
      border-radius: 999px;
      border: none;
      padding: 0.35rem 0.9rem;
      font-size: 0.8rem;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 0.3rem;
    }
    .btn-print {
      background: #111827;
      color: #f9fafb;
    }
    .btn-print:hover {
      background: #020617;
    }

    @media print {
      input[list] {
        font-size: 0.6rem;
      }

      body {
        background: #ffffff;
        margin: 0;
        padding: 0.2rem;
        font-size: 0.9em;
      }
      h1 {
        font-size: 1.15rem;
      }
      h3 {
        font-size: 0.88rem;
      }
      .small {
        font-size: 0.68rem;
      }
      .section {
        box-shadow: none;
        border-radius: 0;
        margin-bottom: 0.35rem;
        padding: 0.55rem;
      }
      .inline-grid {
        gap: 0.28rem;
      }
      .field-pair {
        gap: 0.1rem;
      }
      table {
        font-size: 0.68rem;
      }
      th, td {
        padding: 0.16rem 0.22rem;
      }
      .signature-block {
        margin-bottom: 0.7rem;
      }
      .signature-block input[type="text"] {
        margin-top: 0.08rem !important;
      }
      .actions {
        display: none !important;
      }
    }
  
/* Center all numeric inputs and numeric read-only outputs */
input[type="number"],
input[type="text"][readonly] {
  text-align: center !important;
}


    /* Signature upload UI overrides */
.signature-space {
  height: 60px;
  width: 100%;
  display: flex;
  align-items: center;
  justify-content: center;
  border: 1px dashed var(--border-color);
  background: #ffffff;
  overflow: hidden;
}

.signature-space img {
  max-height: 100%;
  max-width: 100%;
  object-fit: contain;
  pointer-events: none;
  -webkit-user-drag: none;
}

.signature-upload-wrapper {
  margin-top: 0.15rem;
  position: relative;
  display: inline-block;
}

.signature-upload-label {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  background: #111827;
  color: #f9fafb;
  border-radius: 999px;
  padding: 0.35rem 0.9rem;
  font-size: 0.8rem;
  cursor: pointer;
  user-select: none;
  text-decoration: none;
  border: none;
}

.signature-upload-label:hover {
  background: #020617;
}

.signature-upload {
  display: none;
}

@media print {
  .signature-upload-wrapper {
    display: none !important;
  }
}

}

</style>
</head>
<body>
  <h1>CONFINED SPACE VENTILATION PLAN</h1>

  <div class="section">
    <div class="inline-grid">
      <div>
        <div class="template-label">Equipment Name &amp; Number</div>
        <textarea id="equipmentNameNo"></textarea>
      </div>
      <div>
        <div class="template-label">Area / Unit Location</div>
        <textarea id="areaLocation"></textarea>
      </div>
    </div>

    <h3>Contaminant Information</h3>
    <div class="inline-grid">
      <div class="field-pair">
        <label for="contaminantType">Type of Contaminant Released</label>
        <input list="contaminantTypeList" id="contaminantType">
        <datalist id="contaminantTypeList">
          <option value="Vapour/Gas (i.e. painting | chemical cleaning)">
          <option value="Fume/Particulate (i.e. welding | grinding | cutting)">
          <option value="No additional contaminants generated (i.e. inspection | desludging)">
          <option value="Others - please specify">
        </datalist>
      </div>
      <div class="field-pair">
        <label for="degreeReleased">Degree of Contaminant Released</label>
        <input list="degreeReleasedList" id="degreeReleased">
        <datalist id="degreeReleasedList">
          <option value="Low [10ACH]">
          <option value="Moderate [20ACH]">
          <option value="High [30ACH]">
          <option value="Large Tank [5ACH] under deviation">
        </datalist>
      </div>
    </div>

    <div class="template-label" style="margin-top:0.5rem;">Determination of Degree of Released (refer DOR guide)</div>
    <textarea id="degreeDetermination"></textarea>

    <h3>Equipment Volume</h3>
    <div class="shape-switch">

<label><input type="radio" name="shape" value="cuboid" checked> Cuboid (L Ã— W Ã— H)</label>
<label><input type="radio" name="shape" value="cylinder"> Cylinder (Ï€ Ã— RÂ² Ã— H)</label>
<label><input type="radio" name="shape" value="sphere"> Sphere (4/3 Ã— Ï€ Ã— RÂ³)</label>
<label><input type="radio" name="shape" value="other"> Others (m&sup3;)</label>
    </div>

    <div id="cuboidSection" class="shape-section active">
      <div class="inline-grid">
        <div class="field-pair">
          <label for="len">Length - L (m)</label>
          <input type="number" id="len" step="0.01">
        </div>
        <div class="field-pair">
          <label for="wid">Width - W (m)</label>
          <input type="number" id="wid" step="0.01">
        </div>
        <div class="field-pair">
          <label for="hCuboid">Height - H (m)</label>
          <input type="number" id="hCuboid" step="0.01">
        </div>
      </div>
    </div>

    <div id="cylinderSection" class="shape-section">
      <div class="inline-grid">
        <div class="field-pair">
          <label for="rad">Radius - R (m)</label>
          <input type="number" id="rad" step="0.01">
        </div>
        <div class="field-pair">
          <label for="hCyl">Height - H (m)</label>
          <input type="number" id="hCyl" step="0.01">
        </div>
      </div>
    </div>

<div id="sphereSection" class="shape-section">
  <div class="inline-grid">
    <div class="field-pair">
      <label for="radSphere">Radius - R (m)</label>
      <input type="number" id="radSphere" step="0.01">
    </div>
  </div>
</div>

<div id="otherSection" class="shape-section">
  <div class="inline-grid">
    <div class="field-pair">
      <label for="otherVolume">Enter Volume - V (mÂ³)</label>
      <input type="number" id="otherVolume" step="0.01" placeholder="Key in measured / calculated volume">
    </div>
  </div>
</div>


    <div class="inline-grid" style="margin-top:0.5rem;">
      <div class="field-pair">
        <label for="equipVolume">Volume - V (mÂ³)</label>
        <input type="text" id="equipVolume" readonly>
      </div>
    </div>

    <p class="small">
      Reference: Cylinder V = 3.14 Ã— RÂ² Ã— H &nbsp;&nbsp; Cuboid V = L Ã— W Ã— H &nbsp;&nbsp; Sphere V = 4/3 Ã— 3.14 Ã— RÂ³ &nbsp;&nbsp; Conversion: 1 ftÂ³/min = 1.7 mÂ³/hr
    </p>

    <h3>Required Ventilation Rate</h3>
    <div class="inline-grid">
      <div class="field-pair">
        <label for="qVent">Required Ventilation Rate Q (mÂ³/hr) [Q = V Ã— ACH]</label>
        <input type="text" id="qVent" readonly>
      </div>
    </div>

    <h3>Blower Specifications</h3>
    <table>
      <thead>
        <tr>
          <th>Model No.</th>
          <th>Blower Ventilation Rate (mÂ³/hr)</th>
          <th>Quantity</th>
          <th>Total Blower Ventilation Rate (mÂ³/hr)</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td><input type="text" id="blowerModel1"></td>
          <td><input type="number" id="blowerRate1" step="1"></td>
          <td><input type="number" id="blowerQty1" step="1"></td>
          <td><input type="text" id="blowerTotal1" readonly></td>
        </tr>
        <tr>
          <td><input type="text" id="blowerModel2"></td>
          <td><input type="number" id="blowerRate2" step="1"></td>
          <td><input type="number" id="blowerQty2" step="1"></td>
          <td><input type="text" id="blowerTotal2" readonly></td>
        </tr>
        <tr>
          <td><input type="text" id="blowerModel3"></td>
          <td><input type="number" id="blowerRate3" step="1"></td>
          <td><input type="number" id="blowerQty3" step="1"></td>
          <td><input type="text" id="blowerTotal3" readonly></td>
        </tr>
      </tbody>
    </table>

    <div class="inline-grid" style="margin-top:0.5rem;">
      <div class="field-pair">
        <label for="deratePct"><strong>Derating Factor (%)</strong></label>
        <input type="number" id="deratePct" value="90" min="50" max="100" step="1">
      </div>
      <div class="field-pair">
        <label for="overallBlower"><strong>Overall Blower Ventilation Rate (Derated)</strong></label>
        <input type="text" id="overallBlower" readonly>
      </div>
      <div class="field-pair">
        <label>Status</label>
        <span id="statusBox" class="status-box"></span>
      </div>
    </div>

    <p class="small">
      <p class="small" style="font-style:italic; margin-top:0.3rem; margin-bottom:0.3rem;">
Overall blower ventilation rate shall be higher than Required Ventilation Rate Q.<br>
Document to be attached: equipment blower/extractor configuration, equipment engineering drawing, blower/extractor datasheet.
</p>
    </p>

    <h3>Alternative Ventilation Plan (if applicable)</h3>
    <p class="small" style="margin-top:0.25rem;">
      Note: If the ventilation rate is inadequate or installation of the blower is impractical, an alternative ventilation plan (e.g. for gas/vapour generation or fume/particulate generation) shall be developed and attached. This ventilation plan shall be attached to the alternative ventilation plan for reference.
    </p>

    <div class="inline-grid" style="margin-top:0.35rem;">
      <div class="field-pair">
        <label>Alternative ventilation plan attached?</label>
        <div style="display:flex;align-items:center;gap:0.75rem;">
          <label><input type="radio" name="altPlanAttached" value="yes"> Yes</label>
          <label><input type="radio" name="altPlanAttached" value="no" checked> No</label>
        </div>
      </div>
      <div class="field-pair" id="altPlanRefRow" style="display:none;">
        <label for="altPlanRef">Alternative ventilation plan</label>
        <input list="altPlanRefList" id="altPlanRef" placeholder="Select or type reference">
        <datalist id="altPlanRefList">
          <option value="Particulate/Fume Producing Activity">
          <option value="Chemical Generation Activity">
          <option value="Large Tank Maintenance (Under Deviation)">
        </datalist>
      </div>
    </div>

    <h3>Signatures</h3>
    <div class="inline-grid">
      <div class="signature-block">
        <div class="template-label">Prepared by </div>
        <div class="signature-space" id="preparedSignatureBox"></div>
        <div class="signature-upload-wrapper">
          <label class="signature-upload-label" for="preparedSignatureFile">Upload Signature</label><input type="file" id="preparedSignatureFile" class="signature-upload" accept="image/*">
        </div>
        <input type="text" placeholder="Name">
        <input type="text" placeholder="Position" style="margin-top:0.15rem;">
        <input type="text" placeholder="Date" style="margin-top:0.15rem;">
      </div>
      <div class="signature-block">
        <div class="template-label">Reviewed by </div>
        <div class="signature-space" id="reviewedSignatureBox"></div>
        <div class="signature-upload-wrapper">
          <label class="signature-upload-label" for="reviewedSignatureFile">Upload Signature</label><input type="file" id="reviewedSignatureFile" class="signature-upload" accept="image/*">
        </div>
        <input type="text" placeholder="Name">
        <input type="text" placeholder="Position" style="margin-top:0.15rem;">
        <input type="text" placeholder="Date" style="margin-top:0.15rem;">
      </div>
      <div class="signature-block">
        <div class="template-label">Approved by </div>
        <div class="signature-space" id="approvedSignatureBox"></div>
        <div class="signature-upload-wrapper">
          <label class="signature-upload-label" for="approvedSignatureFile">Upload Signature</label><input type="file" id="approvedSignatureFile" class="signature-upload" accept="image/*">
        </div>
        <input type="text" placeholder="Name">
        <input type="text" placeholder="Position" style="margin-top:0.15rem;">
        <input type="text" placeholder="Date" style="margin-top:0.15rem;">
      </div>
    </div>

    <div class="actions">
      <button class="btn-print" onclick="window.print()">
        ðŸ–¨ Print Ventilation Plan
      </button>
    </div>
  </div>

  <script>
    document.addEventListener("DOMContentLoaded", function () {
      const cuboidSection = document.getElementById("cuboidSection");
      const cylinderSection = document.getElementById("cylinderSection");
      const sphereSection = document.getElementById("sphereSection");
      const otherSection = document.getElementById("otherSection");
      const volumeField = document.getElementById("equipVolume");
      const qVentField = document.getElementById("qVent");
      const overallBlowerField = document.getElementById("overallBlower");
      const statusBox = document.getElementById("statusBox");
      const degreeReleasedInput = document.getElementById("degreeReleased");

      function recalcVolume() {
        const shape = document.querySelector('input[name="shape"]:checked').value;
        let V = NaN;

        
// Reset volume
if (shape === "cuboid") {
  const L = parseFloat(document.getElementById("len").value);
  const W = parseFloat(document.getElementById("wid").value);
  const H = parseFloat(document.getElementById("hCuboid").value);
  if (!isNaN(L) && !isNaN(W) && !isNaN(H)) {
    V = L * W * H;
  }
} else if (shape === "cylinder") {
  const R = parseFloat(document.getElementById("rad").value);
  const H = parseFloat(document.getElementById("hCyl").value);
  if (!isNaN(R) && !isNaN(H)) {
    V = 3.14 * R * R * H;
  }
} else if (shape === "sphere") {
  const R = parseFloat(document.getElementById("radSphere").value);
  if (!isNaN(R)) {
    V = (4 / 3) * 3.14 * R * R * R;
  }
} else if (shape === "other") {
  const OV = parseFloat(document.getElementById("otherVolume").value);
  if (!isNaN(OV)) {
    V = OV;
  }
}

        

        if (!isNaN(V)) {
          volumeField.value = Number(V.toFixed(2)).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
        } else {
          volumeField.value = "";
        }

        recalcVentilation();
      }

      function recalcVentilation() {
        const V = parseFloat((volumeField.value || "").toString().replace(/,/g, ""));
        const degreeText = degreeReleasedInput.value || "";
        let ach = NaN;

        if (degreeText) {
          const match = degreeText.match(/(\d+(?:\.\d+)?)/);
          if (match) {
            ach = parseFloat(match[1]);
          }
        }

        if (!isNaN(V) && !isNaN(ach)) {
          const q = V * ach;
          qVentField.value = Number(q.toFixed(1)).toLocaleString('en-US', {minimumFractionDigits: 1, maximumFractionDigits: 1});
        } else {
          qVentField.value = "";
        }
        recalcStatus();
      }

      function recalcBlowers() {
        function rowTotal(rateId, qtyId, outId) {
          const rate = parseFloat(document.getElementById(rateId).value);
          const qty = parseFloat(document.getElementById(qtyId).value);
          const out = document.getElementById(outId);
          let t = NaN;
          if (!isNaN(rate) && !isNaN(qty)) {
            t = rate * qty;
            out.value = Number(t.toFixed(1)).toLocaleString('en-US', {minimumFractionDigits: 1, maximumFractionDigits: 1});
          } else {
            out.value = "";
          }
          return isNaN(t) ? 0 : t;
        }

        const t1 = rowTotal("blowerRate1", "blowerQty1", "blowerTotal1");
        const t2 = rowTotal("blowerRate2", "blowerQty2", "blowerTotal2");
        const t3 = rowTotal("blowerRate3", "blowerQty3", "blowerTotal3");

        const overall = t1 + t2 + t3;

        if (overall > 0) {
          const derateEl = document.getElementById("deratePct");
          const deratePct = derateEl ? parseFloat(derateEl.value) : NaN;
          const derate = (!isNaN(deratePct) && deratePct > 0) ? (deratePct / 100) : 0.9;
          const ov90 = overall * derate; // derated performance
          overallBlowerField.value = Number(ov90.toFixed(1)).toLocaleString('en-US', {minimumFractionDigits: 1, maximumFractionDigits: 1});
        } else {
          overallBlowerField.value = "";
        }

        recalcStatus();
      }

      function recalcStatus() {
        const overall = parseFloat((overallBlowerField.value || "").toString().replace(/,/g, ""));
        const qVent = parseFloat((qVentField.value || "").toString().replace(/,/g, ""));

        if (!isNaN(overall) && !isNaN(qVent) && overall > 0 && qVent > 0) {
          if (overall >= qVent) {
            statusBox.textContent = "Sufficient blower capacity";
            statusBox.className = "status-box status-ok";
          } else {
            statusBox.textContent = "Insufficient blower capacity";
            statusBox.className = "status-box status-bad";
          }
        } else {
          statusBox.textContent = "";
          statusBox.className = "status-box";
        }
      }

      // Shape switch behaviour
      document.querySelectorAll('input[name="shape"]').forEach(function (radio) {
  radio.addEventListener("change", function () {
    const shape = this.value;

    cuboidSection.classList.toggle("active", shape === "cuboid");
    cylinderSection.classList.toggle("active", shape === "cylinder");
    sphereSection.classList.toggle("active", shape === "sphere");
    otherSection.classList.toggle("active", shape === "other");

    // Clear fields of the hidden shapes (prevents stale values affecting calc)
    if (shape !== "cuboid") {
      document.getElementById("len").value = "";
      document.getElementById("wid").value = "";
      document.getElementById("hCuboid").value = "";
    }
    if (shape !== "cylinder") {
      document.getElementById("rad").value = "";
      document.getElementById("hCyl").value = "";
    }
    if (shape !== "sphere") {
      document.getElementById("radSphere").value = "";
    }
    if (shape !== "other") {
      document.getElementById("otherVolume").value = "";
    }

    recalcVolume();
  });
});

      // Inputs for volume
      ["len", "wid", "hCuboid", "rad", "hCyl", "radSphere", "otherVolume"].forEach(function (id) {
        const el = document.getElementById(id);
        if (el) el.addEventListener("input", recalcVolume);
      });

      // Degree of contaminant released (ACH) input
      if (degreeReleasedInput) {
        degreeReleasedInput.addEventListener("input", recalcVentilation);
      }

      // Inputs for blower rows
      ["blowerRate1","blowerQty1","blowerRate2","blowerQty2","blowerRate3","blowerQty3"].forEach(function (id) {
        const el = document.getElementById(id);
        if (el) el.addEventListener("input", recalcBlowers);
      });


      
      // Derating factor input
      const derateEl = document.getElementById("deratePct");
      if (derateEl) derateEl.addEventListener("input", recalcBlowers);
// Alternative ventilation plan toggle
      document.querySelectorAll('input[name="altPlanAttached"]').forEach(function (radio) {
        radio.addEventListener("change", function () {
          const row = document.getElementById("altPlanRefRow");
          if (this.value === "yes") {
            row.style.display = "";
          } else {
            row.style.display = "none";
            const refInput = document.getElementById("altPlanRef");
            if (refInput) refInput.value = "";
          }
        });
      });


      // Signature upload: draw image as background on the signature box (harder to save separately)
      // Signature upload: render as <img> inside the box (prints reliably)
function setupSignatureUpload(fileInputId, boxId) {
  const fileInput = document.getElementById(fileInputId);
  const box = document.getElementById(boxId);
  if (!fileInput || !box) return;

  fileInput.addEventListener("change", function () {
    const file = this.files && this.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = function (e) {
      const dataUrl = e.target.result;

      let img = box.querySelector("img");
      if (!img) {
        img = document.createElement("img");
        box.innerHTML = "";
        box.appendChild(img);
      }
      img.src = dataUrl;
    };
    reader.readAsDataURL(file);
  });
}

setupSignatureUpload("preparedSignatureFile", "preparedSignatureBox");
      setupSignatureUpload("reviewedSignatureFile", "reviewedSignatureBox");
      setupSignatureUpload("approvedSignatureFile", "approvedSignatureBox");

      // Initial calculation
      recalcVolume();
    });
  
// Disable right-click on signature areas
document.addEventListener("contextmenu", function (e) {
  if (e.target.closest(".signature-space")) {
    e.preventDefault();
  }
});
  </script>
</body>
</html>
